<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Microbit Controller App</title>
    <style>
        :root {
            --led-glass: rgba(255, 255, 255, 0.05);
            --bg: #0d0f12;
            --white: #eafcff;
            --glass: rgba(255, 255, 255, 0.03);
            --accent: linear-gradient(90deg, #00c3ff, #00ffa3);
            --accent-solid: #00c3ff;
            --accent-2: #00ffa3;
            --muted: #9fdfff;
            --shadow: 0 18px 60px rgba(0, 0, 0, 0.6);
            --radius: 22px;
            --gap: 48px;
            --control-size: 420px;
            --arrow-size: 110px;
            --center-size: 160px;
            --ctrl-gap: 54px;
            --btn-h: 56px;
            --font-sans: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            --payload-color: #00e0ff;
        }

        .top-header {
            position: fixed;
            top: 50px;
            left: 70px;
            display: flex;
            align-items: center;
            z-index: 100;
        }

        .logo {
            height: 70px;
            width: auto;
            cursor: pointer;
            transition: transform 0.2s ease;
            filter: brightness(1.05);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        html,
        body {
            height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: var(--font-sans);
            background: var(--bg);
            color: var(--white);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .wrap {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .app {
            width: 1400px;
            max-width: 96vw;
            min-height: 85vh;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.008));
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 44px;
            display: flex;
            gap: var(--gap);
            align-items: stretch;
            overflow: hidden;
        }

        .panel-left {
            flex: 1;
            min-width: 520px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px;
        }

        .controller {
            width: var(--control-size);
            height: var(--control-size);
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            grid-template-columns: 1fr auto 1fr;
            place-items: center;
            position: relative;
            gap: var(--ctrl-gap);
        }

        .arrow-btn {
            width: var(--arrow-size);
            height: var(--arrow-size);
            border-radius: 18px;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform .14s cubic-bezier(.2, .9, .3, 1), box-shadow .14s, background .14s;
            user-select: none;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.02);
            --icon-scale: 36px;
            position: relative;
            overflow: hidden;
        }

        .arrow-btn .arrow-icon {
            width: var(--icon-scale);
            height: var(--icon-scale);
            fill: var(--muted);
            opacity: 0.98;
            transition: fill .12s ease;
        }

        .arrow-btn:active,
        .arrow-btn.pressed,
        .arrow-btn.active {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 28px 60px rgba(0, 0, 0, 0.6);
        }

        .arrow-btn.active,
        .arrow-btn.pressed {
            background: var(--accent) !important;
            border-color: rgba(0, 0, 0, 0.12);
        }

        .arrow-btn.active .arrow-icon,
        .arrow-btn.pressed .arrow-icon {
            fill: var(--bg) !important;
            opacity: 1;
        }

        .up {
            grid-row: 1;
            grid-column: 2
        }

        .left {
            grid-row: 2;
            grid-column: 1
        }

        .right {
            grid-row: 2;
            grid-column: 3
        }

        .down {
            grid-row: 3;
            grid-column: 2
        }

        .dot {
            grid-row: 2;
            grid-column: 2;
            width: var(--center-size);
            height: var(--center-size);
            border-radius: 999px;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.45);
            transform-origin: center;
            cursor: pointer;
            transition: box-shadow .12s ease, background .12s ease, transform .12s ease;
            position: relative;
            overflow: hidden;
        }

        .dot svg {
            width: 56px;
            height: 56px;
            fill: var(--muted);
            transition: fill .12s ease
        }

        .dot.listening,
        .voice-btn.listening {
            box-shadow: 0 32px 110px rgba(0, 0, 0, 0.5), 0 0 0 12px rgba(0, 195, 255, 0.06);
            background: var(--accent) !important;
            transform: translateY(-6px) scale(1.02);
        }

        .dot.listening svg,
        .voice-btn.listening svg {
            fill: var(--bg) !important;
        }

        .ripple {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: rgba(0, 195, 255, 0.06);
            pointer-events: none;
            transform: scale(0);
            opacity: 0;
        }

        .control-modes {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            background: var(--glass);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            transition: all .12s ease;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .mode-btn.active {
            background: var(--white);
            color: var(--bg);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .mode-btn:active,
        .mode-btn.pressed {
            transform: translateY(2px) scale(0.995);
            box-shadow: none;
        }

        .panel-right {
            width: 520px;
            max-width: 48%;
            padding: 28px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 22px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.02);
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.28);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .slider-label {
            width: 110px;
            font-weight: 800;
            font-size: 14px;
            color: var(--muted)
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            flex: 1;
            background: transparent;
            outline: none;
            border-radius: 8px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            height: 8px;
            background: linear-gradient(90deg, var(--accent-solid), var(--accent-2));
            border-radius: 8px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.4);
            margin-top: -7px;
        }

        .value-badge {
            min-width: 56px;
            text-align: center;
            font-weight: 800;
            background: linear-gradient(90deg, var(--accent-solid), var(--accent-2));
            padding: 10px;
            border-radius: 12px;
            font-size: 15px;
            color: var(--bg);
        }

        .voice-display {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.01);
            min-height: 64px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-weight: 700;
            color: var(--white);
        }

        .voice-label {
            opacity: 0.85;
            font-size: 13px;
            font-weight: 800;
            color: var(--muted)
        }

        .device-controls {
            display: flex;
            gap: 14px;
            align-items: center;
            justify-content: flex-start;
        }

        .btn {
            background: var(--white);
            color: var(--bg);
            border: none;
            padding: 12px 20px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            height: var(--btn-h);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn.ghost {
            background: transparent;
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .btn:active,
        .btn.pressed {
            transform: translateY(2px) scale(0.995);
            box-shadow: none;
        }

        .conn-small {
            font-size: 16px;
            opacity: .95;
            color: var(--muted);
            text-align: center;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .voice-mode .arrow-btn {
            display: none;
        }

        .voice-mode .dot {
            display: none;
        }

        .voice-mode .controller {
            grid-template-rows: 1fr;
            grid-template-columns: 1fr;
            place-items: center;
        }

        .click-ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            opacity: 0.36;
            pointer-events: none;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.55) 20%, rgba(255, 255, 255, 0.18) 40%, transparent 60%);
        }

        @media (max-width: 1200px) {
            :root {
                --control-size: 360px;
                --arrow-size: 90px;
                --center-size: 140px;
                --gap: 28px;
            }

            .panel-right {
                width: 440px;
            }
        }

        @media (max-width: 900px) {
            .app {
                flex-direction: column;
                padding: 20px;
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }

            .panel-left {
                min-width: unset;
                width: 100%;
                padding: 10px;
            }

            .panel-right {
                width: 100%;
                max-width: 100%;
                padding: 10px;
            }

            :root {
                --control-size: 320px;
                --arrow-size: 82px;
                --center-size: 120px;
                --gap: 20px;
            }

            .top-header {
                position: absolute;
                top: 20px;
                left: 20px;
            }

            .panels-container {
                margin-top: 80px !important;
            }
        }

        @media (max-width: 600px) {
            .logo {
                height: 50px;
            }

            .top-header {
                top: 15px;
                left: 15px;
            }

            :root {
                --control-size: 280px;
                --arrow-size: 70px;
                --center-size: 100px;
                --ctrl-gap: 30px;
            }

            .arrow-btn {
                border-radius: 14px;
            }

            .dot {
                border-radius: 50%;
            }

            .controller {
                gap: 10px;
            }

            .led-grid {
                grid-template-columns: repeat(2, 1fr);
                width: 100%;
            }

            .grid-btn {
                width: auto;
                height: 70px;
                font-size: 16px;
            }

            .big-btn {
                width: 100px;
                height: 100px;
            }

            .mode-btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .card {
                padding: 16px;
            }
        }

        .led-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            width: 100%;
        }

        .led-row {
            display: flex;
            gap: 12px;
            width: 100%;
            justify-content: center;
        }

        .led-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
        }

        .grid-btn {
            width: 130px;
            height: 85px;
            border-radius: 14px;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--muted);
            font-size: 19px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .big-btn {
            width: 120px;
            height: 100px;
            border-radius: 16px;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .big-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .big-btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .btn-active {
            box-shadow: 0 0 20px var(--glow-color, rgba(0, 195, 255, 0.4)), inset 0 0 10px var(--glow-color, rgba(0, 195, 255, 0.2)) !important;
            border-color: var(--glow-color, #00c3ff) !important;
            transform: scale(1.05);
            z-index: 5;
        }

        .grid-btn:active {
            transform: scale(0.96);
        }

        .conn-header {
            display: flex;
            border: 1px solid rgba(255, 255, 255, 0.02);
            flex-direction: row;
            justify-content: center;
        }

        .status-badge {
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            color: var(--muted);
        }

        .tab-content {
            display: none;
            width: 100%;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <header class="top-header">
        <img src="logo.png" alt="Robotic Schools Logo" class="logo">
    </header>
    <div class="wrap">
        <div class="app" role="application" aria-label="Microbit Controller"
            style="flex-direction:column; align-items:center;">
            <div class="panels-container"
                style="display:flex; width:100%; gap:var(--gap); justify-content:center; align-items:flex-start; flex-wrap:wrap; margin-top:100px;">
                <div class="panel-left">
                    <div class="controller" id="controller">
                        <div class="arrow-btn up" data-dir="forward" id="btn-up" title="Forward" role="button"
                            tabindex="0" aria-pressed="false">
                            <svg class="arrow-icon" viewBox="0 0 24 24">
                                <path d="M12 4l-8 8h6v8h4v-8h6z" />
                            </svg>
                        </div>
                        <div class="arrow-btn left" data-dir="left" id="btn-left" title="Left" role="button"
                            tabindex="0" aria-pressed="false">
                            <svg class="arrow-icon" viewBox="0 0 24 24">
                                <path d="M6 12l8-8v6h8v4h-8v6z" />
                            </svg>
                        </div>
                        <div class="dot" id="voiceBtn" title="Press and hold to speak" role="button" tabindex="0"
                            aria-pressed="false" aria-label="Voice input">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                    d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2z" />
                            </svg>
                        </div>
                        <div class="arrow-btn right" data-dir="right" id="btn-right" title="Right" role="button"
                            tabindex="0" aria-pressed="false">
                            <svg class="arrow-icon" viewBox="0 0 24 24">
                                <path d="M18 12l-8 8v-6H2v-4h8V4z" />
                            </svg>
                        </div>
                        <div class="arrow-btn down" data-dir="backward" id="btn-down" title="Backward" role="button"
                            tabindex="0" aria-pressed="false">
                            <svg class="arrow-icon" viewBox="0 0 24 24">
                                <path d="M12 20l8-8h-6V4h-4v8H4z" />
                            </svg>
                        </div>
                        <div class="ripple" id="ripple"></div>
                    </div>
                    <div class="led-layout" id="ledController"
                        style="display:none; flex-direction:row; align-items:center; gap:80px; justify-content:center; flex-wrap:wrap; max-width:800px; padding:0 10px; height:var(--control-size);">
                        <div class="grid-group" id="ledGrid"
                            style="display:grid; grid-template-columns:repeat(2, 1fr); gap:14px;">
                        </div>
                        <div class="center-group">
                            <button id="voiceBtnLed" class="voice-btn" title="Voice Control"
                                style="width:150px; height:150px; border-radius:50%; background:var(--glass); border:2px solid rgba(255,255,255,0.1); cursor:pointer; display:grid; place-items:center;">
                                <svg viewBox="0 0 24 24" style="width:54px; height:54px; fill:#eafcff;">
                                    <path
                                        d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                    <path
                                        d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel-right">
                    <div class="control-modes">
                        <button class="mode-btn active" id="voiceModeBtn">LED Control</button>
                        <button class="mode-btn" id="buttonModeBtn">Robot Control</button>
                    </div>
                    <div class="conn-header"
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; background:rgba(255,255,255,0.02); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.02); margin-bottom:0;">
                        <button id="mainConnectBtn" class="btn primary"
                            style="background:linear-gradient(90deg,#00c3ff,#00ffa3); color:#0d0f12; width:auto; min-width:140px; border:none; padding:8px 20px; font-size:16px;">Connect
                            Micro:bit</button>
                        <div id="mainConnStatus" class="status-badge" style="font-size:15px; padding:6px 14px;">Not
                            connected</div>
                        <div class="conn-small" id="connSmall" style="display:none;"></div>
                    </div>
                    <div id="robotTab" class="tab-content active">
                        <div class="card">
                            <div class="slider-row" aria-hidden="false">
                                <div class="slider-label">SPEED</div>
                                <input id="slider1" type="range" min="0" max="100" value="100"
                                    aria-label="Speed control">
                                <div id="v1" class="value-badge">255</div>
                            </div>
                            <div style="display:none;" id="voiceDisplay">
                                <div id="voiceText"></div>
                            </div>
                        </div>
                        <div class="card"
                            style="margin-top:30px; display:flex; align-items:center; justify-content:center; padding:12px; color:var(--muted); opacity:0.9; min-height:60px;">
                            <div class="log-box"
                                style="font-size:24px; font-weight:800; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                                <span id="lastSentRobot">—</span>
                            </div>
                        </div>
                    </div>
                    <div id="ledTab" class="tab-content">
                        <div class="card"
                            style="display:flex; align-items:center; justify-content:center; padding:12px; color:var(--muted); opacity:0.9; min-height:60px;">
                            <div class="log-box"
                                style="font-size:24px; font-weight:800; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
                                <span id="lastSentVal">—</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        window.sendCommand = sendUART;
        const mainConnStatus = document.getElementById('mainConnStatus');
        const mainConnectBtn = document.getElementById('mainConnectBtn');
        const connSmall = document.getElementById('connSmall');
        const lastSentEl = document.getElementById('lastSentVal');
        const lastSentRobot = document.getElementById('lastSentRobot');
        const slider1 = document.getElementById('slider1');
        const v1 = document.getElementById('v1');
        const voiceTextEl = document.getElementById('voiceText');
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceBtnLed = document.getElementById('voiceBtnLed');
        const ripple = document.getElementById('ripple');
        const controller = document.getElementById('controller');
        const ledController = document.getElementById('ledController');
        const robotTab = document.getElementById('robotTab');
        const ledTab = document.getElementById('ledTab');
        function setConnText(t, color) {
            mainConnStatus.textContent = t;
            mainConnStatus.style.color = color || 'var(--muted)';
            if (t.includes('Connected') && !t.includes('Not') && !t.includes('fail')) {
                mainConnectBtn.textContent = 'Disconnect';
                mainConnectBtn.style.background = 'rgba(255,255,255,0.1)';
                mainConnectBtn.style.color = 'white';
            } else if (t.includes('Disconnect') || t.includes('Not connected')) {
                mainConnectBtn.textContent = 'Connect micro:bit';
                mainConnectBtn.style.background = 'linear-gradient(90deg,#00c3ff,#00ffa3)';
                mainConnectBtn.style.color = '#0d0f12';
            }
        }
        let currentMode = 'button';
        const buttonModeBtn = document.getElementById('buttonModeBtn');
        const voiceModeBtn = document.getElementById('voiceModeBtn');
        function switchMode(mode) {
            currentMode = mode;
            buttonModeBtn.classList.toggle('active', mode === 'button');
            voiceModeBtn.classList.toggle('active', mode === 'voice');
            if (mode === 'button') {
                robotTab.classList.add('active');
                ledTab.classList.remove('active');
            } else {
                robotTab.classList.remove('active');
                ledTab.classList.add('active');
            }
            if (mode === 'voice') {
                controller.style.display = 'none';
                ledController.style.display = 'flex';
            } else {
                controller.style.display = 'grid';
                ledController.style.display = 'none';
            }
            document.querySelectorAll('.arrow-btn').forEach(btn => btn.classList.remove('active', 'pressed'));
            voiceBtn.classList.remove('listening');
            if (voiceBtnLed) voiceBtnLed.classList.remove('listening');
            voiceTextEl.textContent = '—';
            if (lastSentEl) lastSentEl.textContent = '—';
            if (lastSentRobot) lastSentRobot.textContent = '—';
        }
        buttonModeBtn.addEventListener('click', () => switchMode('button'));
        voiceModeBtn.addEventListener('click', () => switchMode('voice'));
        switchMode('voice');
        function animateRipple() {
            const size = Math.max(160, window.innerWidth * 0.08);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = `calc(50% - ${size / 2}px)`;
            ripple.style.top = `calc(50% - ${size / 2}px)`;
            ripple.animate(
                [{ transform: 'scale(0)', opacity: 0.28 }, { transform: 'scale(1.08)', opacity: 0.12 }, { transform: 'scale(1.6)', opacity: 0 }],
                { duration: 520, easing: 'cubic-bezier(.2,.9,.3,1)' }
            );
        }
        let sBusy = false;
        slider1.addEventListener('input', (e) => {
            const scaledValue = Math.round((e.target.value / 100) * 255);
            v1.textContent = scaledValue;
            if (sBusy) return;
            sBusy = true;
            sendUART(`speed${scaledValue}`);
            setTimeout(() => sBusy = false, 140);
        });
        slider1.addEventListener('change', (e) => {
            const scaledValue = Math.round((e.target.value / 100) * 255);
            v1.textContent = scaledValue;
            sendUART(`speed${scaledValue}`);
            sBusy = false;
        });
        const arrowButtons = document.querySelectorAll('.arrow-btn');
        arrowButtonsSetup();
        function arrowButtonsSetup() {
            arrowButtons.forEach(btn => {
                const dir = btn.dataset.dir;
                const press = (ev) => {
                    ev.preventDefault();
                    if (currentMode !== 'button') return;
                    btn.classList.add('pressed', 'active');
                    sendUART(dir);
                };
                const release = (ev) => {
                    ev.preventDefault();
                    if (currentMode !== 'button') return;
                    btn.classList.remove('pressed');
                    setTimeout(() => btn.classList.remove('active'), 180);
                    sendUART('stop');
                };
                btn.addEventListener('mousedown', press);
                btn.addEventListener('touchstart', press, { passive: true });
                btn.addEventListener('mouseup', release);
                btn.addEventListener('mouseleave', release);
                btn.addEventListener('touchend', release);
                btn.addEventListener('keydown', (e) => { if (e.key === ' ' || e.key === 'Enter') { press(e); } });
                btn.addEventListener('keyup', (e) => { if (e.key === ' ' || e.key === 'Enter') { release(e); } });
            });
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
        let recognizer = null;
        let isListening = false;
        let micActive = false;
        let silenceTimer = null;
        let restartBackoff = 250;
        const RESTART_BACKOFF_MAX = 2000;
        const SILENCE_MS = 2000;
        let lastResultAt = 0;
        let nextUtteranceShouldReplace = false;
        function clearSilenceTimer() {
            if (silenceTimer) { clearTimeout(silenceTimer); silenceTimer = null; }
        }
        function armSilenceTimer() {
            clearSilenceTimer();
            silenceTimer = setTimeout(() => {
                if (!isListening || !recognizer) return;
                nextUtteranceShouldReplace = true;
            }, SILENCE_MS);
        }
        function createRecognizer() {
            if (!SpeechRecognition) return null;
            if (recognizer) return recognizer;
            const r = new SpeechRecognition();
            r.lang = 'en-US';
            r.interimResults = true;
            r.maxAlternatives = 1;
            r.continuous = true;
            r.onresult = (e) => {
                if (!isListening) return;
                const now = Date.now();
                if (lastResultAt && (now - lastResultAt) > SILENCE_MS) {
                    voiceTextEl.textContent = '';
                }
                let transcript = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const chunk = (e.results[i][0]?.transcript || '').trim();
                    if (chunk) {
                        transcript += (transcript ? ' ' : '') + chunk;
                    }
                }
                transcript = transcript.trim();
                if (!transcript) return;
                voiceTextEl.textContent = transcript;
                if (lastSentEl) lastSentEl.textContent = transcript;
                if (lastSentRobot) lastSentRobot.textContent = transcript;
                const mapped = mapVoiceToCommand(transcript);
                if (mapped) {
                    sendUART(mapped);
                    highlightArrowForCommand(mapped);
                    highlightLedButtonForCommand(mapped);
                }
                if (/\bsend\b/i.test(transcript)) {
                    const cleaned = transcript.replace(/\bsend\b/gi, '').trim();
                    sendUART(cleaned || transcript);
                }
                lastResultAt = now;
                armSilenceTimer();
            };
            r.onend = () => {
                if (isListening) {
                    // Explicitly active in UI - Must keep alive
                    setTimeout(() => {
                        try { r.start(); } catch (e) { }
                    }, restartBackoff);
                    restartBackoff = Math.min(restartBackoff * 1.5, RESTART_BACKOFF_MAX);
                } else {
                    // UI is 'Stopped'. Engine has ended naturally (timeout/silence).
                    // Do NOT auto-restart here, as it causes random permission prompts on file://
                    // Just mark hardware as inactive so next 'Start' knows to request permission again if needed.
                    micActive = false;
                }
            };
            r.onerror = (err) => {
                if (!isListening) return;
                if (err.error === 'no-speech' || err.error === 'aborted' || err.error === 'network') {
                    try { r.abort(); } catch (e) { }
                    setTimeout(() => {
                        try { r.start(); } catch (e) { }
                    }, restartBackoff);
                    restartBackoff = Math.min(restartBackoff * 1.5, RESTART_BACKOFF_MAX);
                    return;
                }
                isListening = false;
                voiceBtn.classList.remove('listening');
                if (voiceBtnLed) voiceBtnLed.classList.remove('listening');
                // Buttons remain active
                setConnText('Voice: Error', 'salmon');
                clearSilenceTimer();
            };
            return r;
        }
        if (SpeechRecognition) {
            recognizer = createRecognizer();
        }
        async function startListening() {
            if (!SpeechRecognition) {
                alert('Speech recognition not supported in this browser.');
                return;
            }
            if (isListening) return;
            if (!recognizer) recognizer = createRecognizer();
            if (!recognizer) return;
            try {
                isListening = true;
                voiceBtn.classList.add('listening');
                if (voiceBtnLed) voiceBtnLed.classList.add('listening');
                // Remove button disabling logic to allow simultaneous control
                document.querySelectorAll('.led-layout .big-btn, .led-layout .grid-btn').forEach(b => {
                    b.classList.remove('btn-active');
                });
                setConnText('Voice: Listening (click to stop)', '#b5f27d');
                armSilenceTimer();
                if (!micActive) {
                    micActive = true;
                    restartBackoff = 250;
                    recognizer.start();
                }
            } catch (e) {
                console.error(e);
                isListening = false;
                micActive = false;
                voiceBtn.classList.remove('listening');
                if (voiceBtnLed) voiceBtnLed.classList.remove('listening');
                setConnText('Voice: Failed to start', 'salmon');
            }
        }
        function stopListening() {
            isListening = false;
            voiceBtn.classList.remove('listening');
            if (voiceBtnLed) voiceBtnLed.classList.remove('listening');
            setConnText('Voice: Stopped', 'white');
            clearSilenceTimer();
        }
        voiceBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isListening) startListening();
            else stopListening();
        });
        if (voiceBtnLed) {
            voiceBtnLed.addEventListener('click', (e) => {
                e.preventDefault();
                if (!isListening) startListening();
                else stopListening();
            });
        }
        voiceBtn.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                voiceBtn.click();
            }
        });
        const keyMap = {
            'ArrowUp': 'forward', 'ArrowDown': 'backward', 'ArrowLeft': 'left', 'ArrowRight': 'right',
            'w': 'forward', 's': 'backward', 'a': 'left', 'd': 'right',
            'z': 'z', 'x': 'x', ' ': 'stop'
        };
        let activeKeys = new Set();
        document.addEventListener('keydown', (e) => {
            if (currentMode !== 'button') return;
            if (e.repeat) return;
            const cmd = keyMap[e.key] || keyMap[e.code];
            if (cmd) {
                activeKeys.add(e.key);
                sendUART(cmd);
                if (cmd !== 'stop') toggleArrowVisual(cmd, true);
            }
        });
        document.addEventListener('keyup', (e) => {
            if (currentMode !== 'button') return;
            const cmd = keyMap[e.key] || keyMap[e.code];
            if (cmd && activeKeys.has(e.key)) {
                activeKeys.delete(e.key);
                if (cmd !== 'stop') toggleArrowVisual(cmd, false);
                if (activeKeys.size === 0) sendUART('stop');
                else sendUART('stop');
            }
        });
        const ledOps = [
            { l: 'On', c: 'on', b: '', k: '' }, { l: 'Off', c: 'off', b: '', k: '' },
            { l: 'Red', c: 'red', b: '#ff4d4d', k: 'rgba(255, 77, 77, 0.2)' },
            { l: 'Green', c: 'green', b: '#4dff4d', k: 'rgba(77, 255, 77, 0.2)' },
            { l: 'Blue', c: 'blue', b: '#4d4dff', k: 'rgba(77, 77, 255, 0.2)' },
            { l: 'Yellow', c: 'yellow', b: '#ffff4d', k: 'rgba(255, 255, 77, 0.2)' },
            { l: 'Cyan', c: 'cyan', b: '#4dffff', k: 'rgba(77, 255, 255, 0.2)' },
            { l: 'Magenta', c: 'magenta', b: '#ff4dff', k: 'rgba(255, 77, 255, 0.2)' },
            { l: 'White', c: 'white', b: '#ffffff', k: 'rgba(255, 255, 255, 0.15)' },
            { l: 'RGB Off', c: 'rgb off', b: '#ffa500', k: 'rgba(255, 165, 0, 0.2)' }
        ];
        const ledGrid = document.getElementById('ledGrid');
        ledOps.forEach(op => {
            const b = document.createElement('button');
            b.className = 'grid-btn';
            b.textContent = op.l;
            b.dataset.cmd = op.c; // Store command for lookup
            if (op.b) {
                b.style.background = op.k;
                b.style.borderColor = op.b.replace(')', ', 0.4)').replace('rgb', 'rgba');
                if (!b.style.borderColor) b.style.borderColor = op.b;
                b.style.color = 'white';
            } else {
                b.style.borderColor = 'rgba(255,255,255,0.4)';
            }
            b.onclick = () => sendUART(op.c);
            ledGrid.appendChild(b);
        });
        const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const UART_NOTIFY_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        const UART_WRITE_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
        let uBitDevice = null;
        let notifyCharacteristic = null;
        let writeCharacteristic = null;
        let queue = Promise.resolve();
        function queueGattOperation(operation) { queue = queue.then(operation, operation); return queue; }
        function showCharInfo(char, name) { if (!char) return console.log(name + ': null'); console.log(`${name} properties:`, { broadcast: char.properties.broadcast, read: char.properties.read, write: char.properties.write, writeWithoutResponse: char.properties.writeWithoutResponse, notify: char.properties.notify, indicate: char.properties.indicate }); }
        async function connectButtonPressed() {
            try {
                setConnText('Pairing...', 'yellow');
                uBitDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: [UART_SERVICE_UUID]
                });
                uBitDevice.addEventListener('gattserverdisconnected', onDisconnected);
                setConnText('Connecting...', 'yellow');
                const server = await uBitDevice.gatt.connect();
                setConnText('Getting service...', 'yellow');
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                setConnText('Getting characteristics...', 'yellow');
                notifyCharacteristic = await service.getCharacteristic(UART_NOTIFY_CHAR_UUID);
                if (notifyCharacteristic.properties.notify || notifyCharacteristic.properties.indicate) {
                    await notifyCharacteristic.startNotifications();
                    notifyCharacteristic.addEventListener('characteristicvaluechanged', onNotifyValueChanged);
                }
                writeCharacteristic = await service.getCharacteristic(UART_WRITE_CHAR_UUID);
                setConnText('Connected: ' + (uBitDevice.name || 'Micro:Bit'), '#b5f27d');
                document.getElementById('robotShow') && document.getElementById('robotShow').classList && document.getElementById('robotShow').classList.add('robotShow_connected');
            } catch (err) {
                console.error(err);
                setConnText('Connection failed', 'salmon');
            }
        }
        function disconnectButtonPressed() {
            if (!uBitDevice) return;
            if (uBitDevice.gatt.connected) { uBitDevice.gatt.disconnect(); setConnText('Disconnected', 'white'); }
            else setConnText('Not connected', 'white');
        }
        function onDisconnected(event) {
            let device = event.target;
            setConnText('Disconnected', 'white');
            document.getElementById('robotShow') && document.getElementById('robotShow').classList && document.getElementById('robotShow').classList.remove('robotShow_connected');
        }
        function onNotifyValueChanged(event) {
            const value = event.target.value;
            const decoder = new TextDecoder();
            const text = decoder.decode(value);
            if (text.trim() === 'S') console.log('Shaken!');
        }
        async function sendUART(payload) {
            if (lastSentEl) lastSentEl.textContent = payload;
            if (lastSentRobot) lastSentRobot.textContent = payload;
            if (!writeCharacteristic) { setConnText('Not connected - Click Connect first', 'salmon'); return; }
            const encoder = new TextEncoder();
            const data = encoder.encode(payload + '\n');
            queueGattOperation(() => (async () => {
                try {
                    if (writeCharacteristic.properties.write) {
                        await writeCharacteristic.writeValue(data);
                    } else if (writeCharacteristic.properties.writeWithoutResponse) {
                        try { await writeCharacteristic.writeValue(data); }
                        catch (e) { if (typeof writeCharacteristic.writeValueWithoutResponse === 'function') { await writeCharacteristic.writeValueWithoutResponse(data); } else throw e; }
                    } else {
                        throw new Error('Characteristic not writable');
                    }
                } catch (err) { setConnText('Send failed - Check Micro:Bit connection', 'salmon'); }
            })());
        }
        mainConnectBtn.addEventListener('click', () => {
            if (uBitDevice && uBitDevice.gatt.connected) disconnectButtonPressed();
            else connectButtonPressed();
        });
        function toggleArrowVisual(cmd, active) {
            const mapping = { 'forward': 'btn-up', 'backward': 'btn-down', 'left': 'btn-left', 'right': 'btn-right' };
            const id = mapping[cmd];
            if (!id) return;
            const el = document.getElementById(id);
            if (el) {
                if (active) el.classList.add('active');
                else el.classList.remove('active');
            }
        }
        function highlightArrowForCommand(cmd) {
            toggleArrowVisual(cmd, true);
            setTimeout(() => toggleArrowVisual(cmd, false), 360);
        }
        function highlightLedButtonForCommand(cmd) {
            const btn = document.querySelector(`.grid-btn[data-cmd="${cmd}"]`);
            if (btn) {
                // Radio button behavior: Clear others first
                document.querySelectorAll('.grid-btn').forEach(b => b.classList.remove('btn-active'));

                // Manually trigger the visual active state
                // Set glow color based on button border color or default
                let glowColor = '#00c3ff';
                if (btn.style.borderColor && btn.style.borderColor !== '') {
                    glowColor = btn.style.borderColor.replace('0.4', '1').replace('0.3', '1');
                }
                btn.style.setProperty('--glow-color', glowColor);
                btn.classList.add('btn-active');

                // No timeout - stays active until next command
            }
        }
        function mapVoiceToCommand(text) {
            const t = text.toLowerCase();
            if (t.match(/\brgb\s+off\b/)) return 'rgb off';
            const colors = ['red', 'green', 'blue', 'yellow', 'cyan', 'magenta', 'white'];
            for (const c of colors) {
                if (new RegExp('\\b' + c + '\\b').test(t)) return c;
            }
            if (t.match(/\bon\b/)) return 'on';
            if (t.match(/\boff\b/)) return 'off';
            if (t.match(/\b(forward|ahead|up)\b/)) return 'forward';
            if (t.match(/\b(back|backward|reverse|down)\b/)) return 'backward';
            if (t.match(/\bleft\b/)) return 'left';
            if (t.match(/\bright\b/)) return 'right';
            if (t.match(/\bstop\b/)) return 'stop';
            return null;
        }
        function attachClickEffectTo(el, options = {}) {
            el.addEventListener('pointerdown', (ev) => {
                const rect = el.getBoundingClientRect();
                const x = ev.clientX - rect.left;
                const y = ev.clientY - rect.top;
                el.classList.add('pressed');
                let rippleEl = document.createElement('span');
                rippleEl.className = 'click-ripple';
                const size = Math.max(rect.width, rect.height) * 1.2;
                rippleEl.style.width = rippleEl.style.height = size + 'px';
                rippleEl.style.left = (x - size / 2) + 'px';
                rippleEl.style.top = (y - size / 2) + 'px';
                rippleEl.style.opacity = '0.36';
                rippleEl.style.transition = 'transform 420ms cubic-bezier(.2,.9,.3,1), opacity 420ms linear';
                el.appendChild(rippleEl);
                requestAnimationFrame(() => {
                    rippleEl.style.transform = 'scale(1)';
                    rippleEl.style.opacity = '0';
                });
                setTimeout(() => {
                    try { rippleEl.remove(); } catch (e) { }
                }, 520);
            }, { passive: true });
            const remove = () => { el.classList.remove('pressed'); };
            el.addEventListener('pointerup', remove);
            el.addEventListener('pointercancel', remove);
            el.addEventListener('pointerleave', remove);
        }
        const allInteractive = [
            ...document.querySelectorAll('.arrow-btn'),
            ...document.querySelectorAll('.mode-btn'),
            ...document.querySelectorAll('.btn'),
            voiceBtn
        ];
        const cmdButtons = document.querySelectorAll('.big-btn, .grid-btn');
        document.querySelectorAll('.big-btn').forEach(btn => {
            btn.style.setProperty('--glow-color', '#00c3ff');
        });
        cmdButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                cmdButtons.forEach(b => b.classList.remove('btn-active'));
                const target = e.currentTarget;
                if (target.style.borderColor && target.style.borderColor !== '') {
                    target.style.setProperty('--glow-color', target.style.borderColor.replace('0.4', '1').replace('0.3', '1'));
                }
                target.classList.add('btn-active');
            });
        });
        allInteractive.forEach(node => attachClickEffectTo(node));
    </script>
</body>

</html>
